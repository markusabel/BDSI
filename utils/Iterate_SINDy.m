%% Iterate over SINDy method 
% Copyright Robert Niven, 2021-2024, All Rights Reserved

clear k 

'Iterate SINDy **********'

%parameters

k=1;   %matlab problem, cannot start iterations from zero !
lambda(k)=lambda0;    %initial value

while lambda(k) > lambdalim      %iterate to lambda limit criterion
    'Iteration **********'
    k=k+1
    kmax=k
    format longEng    
    %same lambda across all columns
    lambda(k)=lambda(k-1)/lambdafact
    true_Xi
    Xi = sparsifyDynamics(H,dx,lambda(k),o);  %noting dx=Y; allow for separate Y dimension
    Xi_SINDy=Xi

    if knownXi=='Y';     %calc data - known param values in Xi
        diffXi=true_Xi-Xi     %known function
    elseif knownXi=='N'
        diffXi=Xi-Xi          %to show errors; unknown function
    end;

    %2norm quantities
    for i=1:o    %loop over Y dimensions o
        Resid2_SINDy(k,i)= (norm(dx(:,i) - H*Xi(:,i)))^2;
        Reg2_SINDy(k,i)= (norm(Xi(:,i)))^2;
        Jtilde2_SINDy(k,i)=Resid2_SINDy(k,i) + lambda(k) * Reg2_SINDy(k,i);  %Tik obj function 
    end
    Resid2_SINDy(k,:)
    Reg2_SINDy(k,:)
    Jtilde2_SINDy(k,:)       
    %problematic; strictly cannot use 2-norm unless Gaussian isotropic
    %SINDy does not actually use the 2-norm reg term
 
    % Show and compare the coefficients and generated time series
    Title_text='SINDy method'; 
    if dynsys==1
         Show_comparisons6a;
    elseif hydrolmodel==1 | RRmodel==1
         Show_comparisons8;
    end;

end

'Results from all iterations **********'
format longEng

kspan=[2:1:kmax]; %k data starting from 2
lamspan=[lambda(kmax),lambda0]; 

numit_SINDy=kmax
lambda_SINDy = lambda

Resid2_SINDy
Reg2_SINDy
Jtilde2_SINDy  

%Title_text='SINDy'; 
Fighead_text='SINDy iterations';

%plot over iterations

%variation of lambda with k, all dimensions
     figure, %omit dummy first point
        semilogy(kspan, lambda_SINDy(2:end), 'm-o', ...
            'MarkerFaceColor','m'), ...
        xlabel('$k$','Interpreter','latex','FontSize',18),...
        ylabel('$\lambda$','FontSize',18), ...
        ylim(lamspan), ...
        title({fighead; Fighead_text},'FontSize',18)
        ax = gca; ax.XAxis.FontSize = 16; ax.YAxis.FontSize = 16;
        fignum=fignum+1; 
        saveas(gcf,fullfile(pwd, dirname,strcat('Fig',int2str(fignum))),'epsc')

if o==1
   %hardwired 1D; plots against lambda
   %awkward format to allow filled markers

    figure, %omit dummy first point
        loglog(lambda_SINDy(2:end), Resid2_SINDy(2:end,1), 'b-^', ...
            'MarkerFaceColor','b'), ...
        xlabel('$\lambda$','Interpreter','latex','FontSize',18),...
        ylabel('Variable','FontSize',18), ...
        xlim(lamspan), ylim([1.0e-30,1.0e5]), ...
        title({fighead; Fighead_text},'FontSize',18)
        ax = gca; ax.XAxis.FontSize = 16; ax.YAxis.FontSize = 16;
        hold on
        loglog(lambda_SINDy(2:end), Reg2_SINDy(2:end,1), 'r-*')
        loglog(lambda(2:end), Jtilde2_SINDy(2:end,1), 'k-s')
        hold off
        legend({'$||\dot{X}_1 - \Theta \Xi_1||^2_2$', ...
        '$||\Xi_1||^2_2$','${J}^{IT}_1$'}, 'Interpreter','latex',...
        'FontSize',16, ...
        'Location','southoutside')
        fignum=fignum+1; 
        saveas(gcf,fullfile(pwd, dirname,strcat('Fig',int2str(fignum))),'epsc')

    figure, %omit dummy first point
        loglog(lambda_SINDy(2:end), Resid2_SINDy(2:end,1), 'b-^', ...
            'MarkerFaceColor','b'), ...
        xlabel('$\lambda$','Interpreter','latex','FontSize',18),...
        ylabel('Variable','FontSize',18), ...
        xlim(lamspan), ylim([1.0e-30,1.0e5]), ...
        title({fighead; Fighead_text},'FontSize',18)
        ax = gca; ax.XAxis.FontSize = 16; ax.YAxis.FontSize = 16;
        hold on
        loglog(lambda_SINDy(2:end), Reg2_SINDy(2:end,1), 'r-*')
        loglog(lambda(2:end), Jtilde2_SINDy(2:end,1), 'k-s')
        hold off
        fignum=fignum+1; 
        saveas(gcf,fullfile(pwd, dirname,strcat('Fig',int2str(fignum))),'epsc')

elseif o==2
   %hardwired 2D; plots against lambda
   %awkward format to allow filled markers

    figure, %omit dummy first point
        loglog(lambda_SINDy(2:end), Resid2_SINDy(2:end,1), 'b-^', ...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,2), 'b--^', ...
            'MarkerFaceColor','b'), ...
        xlabel('$\lambda$','Interpreter','latex','FontSize',18),...
        ylabel('Variable','FontSize',18), ...
        xlim(lamspan), ylim([1.0e-30,1.0e20]), ...
        title({fighead; Fighead_text},'FontSize',18)
        ax = gca; ax.XAxis.FontSize = 16; ax.YAxis.FontSize = 16;
        hold on
        loglog(lambda_SINDy(2:end), Reg2_SINDy(2:end,1), 'r-*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,2), 'r--*')
        loglog(lambda(2:end), Jtilde2_SINDy(2:end,1), 'k-s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,2), 'k--s')
        hold off
        legend({'$||\dot{X}_1 - \Theta \Xi_1||^2_2$', ...
        '$||\dot{X}_2 - \Theta \Xi_2||^2_2$', ...
        '$||\Xi_1||^2_2$','$||\Xi_2||^2_2$', ...
        '${J}^{IT}_1$','${J}^{IT}_2$'}, ...
        'Interpreter','latex','FontSize',16, ...
        'Location','southoutside')
        fignum=fignum+1; 
        saveas(gcf,fullfile(pwd, dirname,strcat('Fig',int2str(fignum))),'epsc')

    figure, %omit dummy first point
        loglog(lambda_SINDy(2:end), Resid2_SINDy(2:end,1), 'b-^', ...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,2), 'b--^', ...
            'MarkerFaceColor','b'), ...
        xlabel('$\lambda$','Interpreter','latex','FontSize',18),...
        ylabel('Variable','FontSize',18), ...
        xlim(lamspan), ylim([1.0e-30,1.0e20]), ...
        title({fighead; Fighead_text},'FontSize',18)
        ax = gca; ax.XAxis.FontSize = 16; ax.YAxis.FontSize = 16;
        hold on
        loglog(lambda_SINDy(2:end), Reg2_SINDy(2:end,1), 'r-*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,2), 'r--*')
        loglog(lambda(2:end), Jtilde2_SINDy(2:end,1), 'k-s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,2), 'k--s')
        hold off
        fignum=fignum+1; 
        saveas(gcf,fullfile(pwd, dirname,strcat('Fig',int2str(fignum))),'epsc')        

elseif o==3
   %hardwired 3D; plots against lambda
   %awkward format to allow filled markers
    figure, %omit dummy first point
        loglog(lambda_SINDy(2:end), Resid2_SINDy(2:end,1), 'b-^', ...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,2), 'b--^', ...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,3), 'b-.^', 'MarkerFaceColor','b'), ...
        xlabel('$\lambda$','Interpreter','latex','FontSize',18),...
        ylabel('Variable','FontSize',18), ...
        xlim(lamspan), ylim([1.0e-30,1.0e20]), ...
        title({fighead; Fighead_text},'FontSize',18)
        ax = gca; ax.XAxis.FontSize = 16; ax.YAxis.FontSize = 16;
        hold on
        loglog(lambda_SINDy(2:end), Reg2_SINDy(2:end,1), 'r-*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,2), 'r--*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,3), 'r-.*')
        loglog(lambda(2:end), Jtilde2_SINDy(2:end,1), 'k-s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,2), 'k--s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,3), 'k-.s')
        hold off
        legend({'$||\dot{X}_1 - \Theta \Xi_1||^2_2$', ...
        '$||\dot{X}_2 - \Theta \Xi_2||^2_2$', ...
        '$||\dot{X}_3 - \Theta \Xi_3||^2_2$', ...
        '$||\Xi_1||^2_2$','$||\Xi_2||^2_2$','$||\Xi_3||^2_2$', ...
        '${J}^{IT}_1$','${J}^{IT}_2$','${J}^{IT}_3$'}, ...
        'Interpreter','latex','FontSize',16, ...
        'Location','southoutside')
        fignum=fignum+1; 
        saveas(gcf,fullfile(pwd, dirname,strcat('Fig',int2str(fignum))),'epsc')

    figure, %omit dummy first point
        loglog(lambda_SINDy(2:end), Resid2_SINDy(2:end,1), 'b-^', ...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,2), 'b--^', ...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,3), 'b-.^', 'MarkerFaceColor','b'), ...
        xlabel('$\lambda$','Interpreter','latex','FontSize',18),...
        ylabel('Variable','FontSize',18), ...
        xlim(lamspan), ylim([1.0e-30,1.0e20]), ...
        title({fighead; Fighead_text},'FontSize',18)
        ax = gca; ax.XAxis.FontSize = 16; ax.YAxis.FontSize = 16;
        hold on
        loglog(lambda_SINDy(2:end), Reg2_SINDy(2:end,1), 'r-*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,2), 'r--*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,3), 'r-.*')
        loglog(lambda(2:end), Jtilde2_SINDy(2:end,1), 'k-s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,2), 'k--s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,3), 'k-.s')
        hold off
        fignum=fignum+1; 
        saveas(gcf,fullfile(pwd, dirname,strcat('Fig',int2str(fignum))),'epsc')

elseif o==4
   %hardwired 4D; plots against lambda
   %awkward format to allow filled markers
    figure, %omit dummy first point
        loglog(lambda_SINDy(2:end), Resid2_SINDy(2:end,1), 'b-^', ...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,2), 'b--^', ...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,3), 'b-.^',...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,4), 'b:^', ...
            'MarkerFaceColor','b'), ...
        xlabel('$\lambda$','Interpreter','latex','FontSize',18),...
        ylabel('Variable','FontSize',18), ...
        xlim(lamspan), ylim([1.0e-30,1.0e20]), ...
        title({fighead; Fighead_text},'FontSize',18)
        ax = gca; ax.XAxis.FontSize = 16; ax.YAxis.FontSize = 16;
        hold on
        loglog(lambda_SINDy(2:end), Reg2_SINDy(2:end,1), 'r-*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,2), 'r--*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,3), 'r-.*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,4), 'r:*')
        loglog(lambda(2:end), Jtilde2_SINDy(2:end,1), 'k-s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,2), 'k--s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,3), 'k-.s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,4), 'k:s')
        hold off
        legend({'$||\dot{X}_1 - \Theta \Xi_1||^2_2$', ...
        '$||\dot{X}_2 - \Theta \Xi_2||^2_2$', ...
        '$||\dot{X}_3 - \Theta \Xi_3||^2_2$', ...
        '$||\dot{X}_4 - \Theta \Xi_4||^2_2$', ...
        '$||\Xi_1||^2_2$','$||\Xi_2||^2_2$','$||\Xi_3||^2_2$', '$||\Xi_4||^2_2$', ...
        '${J}^{IT}_1$','${J}^{IT}_2$','${J}^{IT}_3$','${J}^{IT}_4$'}, ...
        'Interpreter','latex','FontSize',16, ...
        'Location','southoutside')
        fignum=fignum+1; 
        saveas(gcf,fullfile(pwd, dirname,strcat('Fig',int2str(fignum))),'epsc')

    figure, %omit dummy first point
        loglog(lambda_SINDy(2:end), Resid2_SINDy(2:end,1), 'b-^', ...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,2), 'b--^', ...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,3), 'b-.^',...
            lambda_SINDy(2:end), Resid2_SINDy(2:end,4), 'b:^', ...
            'MarkerFaceColor','b'), ...
        xlabel('$\lambda$','Interpreter','latex','FontSize',18),...
        ylabel('Variable','FontSize',18), ...
        xlim(lamspan), ylim([1.0e-30,1.0e20]), ...
        title({fighead; Fighead_text},'FontSize',18)
        ax = gca; ax.XAxis.FontSize = 16; ax.YAxis.FontSize = 16;
        hold on
        loglog(lambda_SINDy(2:end), Reg2_SINDy(2:end,1), 'r-*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,2), 'r--*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,3), 'r-.*', ...
            lambda_SINDy(2:end), Reg2_SINDy(2:end,4), 'r:*')
        loglog(lambda(2:end), Jtilde2_SINDy(2:end,1), 'k-s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,2), 'k--s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,3), 'k-.s', ...
            lambda_SINDy(2:end), Jtilde2_SINDy(2:end,4), 'k:s')
        hold off
        fignum=fignum+1; 
        saveas(gcf,fullfile(pwd, dirname,strcat('Fig',int2str(fignum))),'epsc')        
end 



